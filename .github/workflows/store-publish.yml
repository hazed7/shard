name: Store publish
# Publishes to AUR, Flathub, and Winget when a release is published

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag to publish (e.g. v0.1.6)"
        required: true
        type: string

permissions:
  contents: read

jobs:
  aur:
    runs-on: ubuntu-latest
    steps:
      - name: Check secret
        id: check
        run: |
          if [ -z "${{ secrets.AUR_SSH_PRIVATE_KEY }}" ]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Collect release info
        if: steps.check.outputs.skip != 'true'
        id: release
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ github.event.release.tag_name || inputs.tag || github.ref_name }}"
          VERSION="${TAG#v}"
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Download checksums
        if: steps.check.outputs.skip != 'true'
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ steps.release.outputs.tag }}"
          curl -sL "https://github.com/th0rgal/shard/releases/download/${TAG}/SHA256SUMS.txt" -o SHA256SUMS.txt

      - name: Prepare shard PKGBUILD
        if: steps.check.outputs.skip != 'true'
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ steps.release.outputs.version }}"
          CLI_SHA=$(grep "shard-cli-linux-x64.tar.gz" SHA256SUMS.txt | cut -d' ' -f1)
          if [ -z "$CLI_SHA" ]; then
            echo "Missing shard-cli-linux-x64.tar.gz hash in SHA256SUMS.txt" >&2
            exit 1
          fi

          mkdir -p shard
          cat > shard/PKGBUILD << 'PKGEOF'
          # Maintainer: Thomas Marchand <thomas@thomas.md>
          pkgname=shard
          pkgver=PKGVER_PLACEHOLDER
          pkgrel=1
          pkgdesc="A minimal, content-addressed Minecraft launcher (CLI)"
          arch=('x86_64')
          url="https://shard.thomas.md"
          license=('MIT')
          depends=('gcc-libs')
          source=("https://github.com/th0rgal/shard/releases/download/v${pkgver}/shard-cli-linux-x64.tar.gz")
          sha256sums=('SHA256_PLACEHOLDER')

          package() {
              install -Dm755 shard "${pkgdir}/usr/bin/shard"
          }
          PKGEOF
          sed -i "s/PKGVER_PLACEHOLDER/${VERSION}/" shard/PKGBUILD
          sed -i "s/SHA256_PLACEHOLDER/${CLI_SHA}/" shard/PKGBUILD

      - name: Prepare shard-launcher-bin PKGBUILD
        if: steps.check.outputs.skip != 'true'
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ steps.release.outputs.version }}"
          DESKTOP_SHA=$(grep "shard-launcher-linux-x64.deb" SHA256SUMS.txt | cut -d' ' -f1)
          if [ -z "$DESKTOP_SHA" ]; then
            echo "Missing shard-launcher-linux-x64.deb hash in SHA256SUMS.txt" >&2
            exit 1
          fi

          mkdir -p shard-launcher-bin
          cat > shard-launcher-bin/PKGBUILD << 'PKGEOF'
          # Maintainer: Thomas Marchand <thomas@thomas.md>
          pkgname=shard-launcher-bin
          pkgver=PKGVER_PLACEHOLDER
          pkgrel=1
          pkgdesc="A minimal, content-addressed Minecraft launcher (Desktop App)"
          arch=('x86_64')
          url="https://shard.thomas.md"
          license=('MIT')
          depends=('webkit2gtk-4.1' 'libappindicator-gtk3')
          provides=('shard-launcher')
          conflicts=('shard-launcher')
          source=("https://github.com/th0rgal/shard/releases/download/v${pkgver}/shard-launcher-linux-x64.deb")
          sha256sums=('SHA256_PLACEHOLDER')

          package() {
              bsdtar -xf data.tar.* -C "${pkgdir}/"
          }
          PKGEOF
          sed -i "s/PKGVER_PLACEHOLDER/${VERSION}/" shard-launcher-bin/PKGBUILD
          sed -i "s/SHA256_PLACEHOLDER/${DESKTOP_SHA}/" shard-launcher-bin/PKGBUILD

      - name: Publish shard to AUR
        if: steps.check.outputs.skip != 'true'
        uses: KSXGitHub/github-actions-deploy-aur@v3
        with:
          pkgname: shard
          pkgbuild: shard/PKGBUILD
          commit_username: 'Thomas Marchand'
          commit_email: 'thomas@thomas.md'
          ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          commit_message: "Update to ${{ steps.release.outputs.tag }}"

      - name: Publish shard-launcher-bin to AUR
        if: steps.check.outputs.skip != 'true'
        uses: KSXGitHub/github-actions-deploy-aur@v3
        with:
          pkgname: shard-launcher-bin
          pkgbuild: shard-launcher-bin/PKGBUILD
          commit_username: 'Thomas Marchand'
          commit_email: 'thomas@thomas.md'
          ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          commit_message: "Update to ${{ steps.release.outputs.tag }}"

  flathub:
    runs-on: ubuntu-latest
    steps:
      - name: Check secret
        id: check
        run: |
          if [ -z "${{ secrets.FLATHUB_TOKEN }}" ]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Checkout repo
        if: steps.check.outputs.skip != 'true'
        uses: actions/checkout@v4

      - name: Collect release info
        if: steps.check.outputs.skip != 'true'
        id: release
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ github.event.release.tag_name || inputs.tag || github.ref_name }}"
          VERSION="${TAG#v}"
          if [ -n "${{ github.event.release.published_at }}" ]; then
            DATE="${{ github.event.release.published_at }}"
            DATE="${DATE%%T*}"
          else
            DATE="$(date -u +%Y-%m-%d)"
          fi
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "date=${DATE}" >> "$GITHUB_OUTPUT"

      - name: Fetch SHA256SUMS
        if: steps.check.outputs.skip != 'true'
        id: hashes
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ steps.release.outputs.tag }}"
          curl -fsSL "https://github.com/th0rgal/shard/releases/download/${TAG}/SHA256SUMS.txt" -o /tmp/SHA256SUMS.txt
          DEB_HASH="$(grep 'shard-launcher-linux-x64.deb' /tmp/SHA256SUMS.txt | awk '{print $1}')"
          if [ -z "$DEB_HASH" ]; then
            echo "Missing shard-launcher-linux-x64.deb hash in SHA256SUMS.txt" >&2
            exit 1
          fi
          echo "deb_hash=${DEB_HASH}" >> "$GITHUB_OUTPUT"

      - name: Update Flathub repo
        if: steps.check.outputs.skip != 'true'
        shell: bash
        env:
          FLATHUB_TOKEN: ${{ secrets.FLATHUB_TOKEN }}
          FLATHUB_REPO: ${{ secrets.FLATHUB_REPO }}
        run: |
          set -euo pipefail
          TAG="${{ steps.release.outputs.tag }}"
          VERSION="${{ steps.release.outputs.version }}"
          DATE="${{ steps.release.outputs.date }}"
          DEB_HASH="${{ steps.hashes.outputs.deb_hash }}"
          FLATHUB_REPO="${FLATHUB_REPO:-flathub/sh.shard.launcher}"

          git clone "https://x-access-token:${FLATHUB_TOKEN}@github.com/${FLATHUB_REPO}.git" flathub-repo
          cd flathub-repo

          # Update manifest
          sed -i "s|url: .*shard-launcher-linux-x64\.deb|url: https://github.com/th0rgal/shard/releases/download/${TAG}/shard-launcher-linux-x64.deb|" md.thomas.shard.launcher.yml
          sed -i "s|sha256: [0-9A-Fa-f]*|sha256: ${DEB_HASH}|" md.thomas.shard.launcher.yml

          # Update metainfo with new release
          RELEASE_ENTRY="    <release version=\"${VERSION}\" date=\"${DATE}\">\n      <description>\n        <p>Release ${VERSION}</p>\n      </description>\n    </release>"
          sed -i "s|<releases>|<releases>\n${RELEASE_ENTRY}|" md.thomas.shard.launcher.metainfo.xml

          git add md.thomas.shard.launcher.yml md.thomas.shard.launcher.metainfo.xml
          git -c user.name="github-actions" -c user.email="github-actions@github.com" commit -m "Update Shard Launcher to ${VERSION}"
          git push

  winget:
    runs-on: ubuntu-latest
    steps:
      - name: Check secret
        id: check
        run: |
          if [ -z "${{ secrets.WINGET_TOKEN }}" ]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Checkout repo
        if: steps.check.outputs.skip != 'true'
        uses: actions/checkout@v4

      - name: Collect release info
        if: steps.check.outputs.skip != 'true'
        id: release
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ github.event.release.tag_name || inputs.tag || github.ref_name }}"
          VERSION="${TAG#v}"
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Fetch SHA256SUMS
        if: steps.check.outputs.skip != 'true'
        id: hashes
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ steps.release.outputs.tag }}"
          curl -fsSL "https://github.com/th0rgal/shard/releases/download/${TAG}/SHA256SUMS.txt" -o /tmp/SHA256SUMS.txt
          MSI_HASH="$(grep 'shard-launcher-windows-x64.msi$' /tmp/SHA256SUMS.txt | awk '{print $1}')"
          if [ -z "$MSI_HASH" ]; then
            echo "Missing shard-launcher-windows-x64.msi hash in SHA256SUMS.txt" >&2
            exit 1
          fi
          echo "msi_hash=${MSI_HASH}" >> "$GITHUB_OUTPUT"

      - name: Update winget manifests and open PR
        if: steps.check.outputs.skip != 'true'
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.WINGET_TOKEN }}
          WINGET_FORK: ${{ secrets.WINGET_FORK }}
          WINGET_BASE: ${{ secrets.WINGET_BASE }}
        run: |
          set -euo pipefail
          TAG="${{ steps.release.outputs.tag }}"
          VERSION="${{ steps.release.outputs.version }}"
          MSI_HASH="${{ steps.hashes.outputs.msi_hash }}"
          WINGET_FORK="${WINGET_FORK:-Th0rgal/winget-pkgs}"
          WINGET_BASE="${WINGET_BASE:-microsoft/winget-pkgs}"

          git clone "https://x-access-token:${GH_TOKEN}@github.com/${WINGET_FORK}.git" winget-pkgs
          cd winget-pkgs
          BRANCH="shardlauncher-${VERSION}"
          git checkout -b "$BRANCH"

          TARGET_DIR="manifests/t/Th0rgal/ShardLauncher/${VERSION}"
          mkdir -p "$TARGET_DIR"
          cp -R "$GITHUB_WORKSPACE/packaging/winget/Th0rgal.ShardLauncher/0.1.4/." "$TARGET_DIR/"

          # Update version and hash in manifest files
          find "$TARGET_DIR" -name "*.yaml" -exec sed -i "s/PackageVersion: 0.1.4/PackageVersion: ${VERSION}/" {} \;
          find "$TARGET_DIR" -name "*.yaml" -exec sed -i "s|/download/v0.1.4/|/download/${TAG}/|" {} \;
          find "$TARGET_DIR" -name "*.yaml" -exec sed -i "s/InstallerSha256: 5245BE2EDD1E83660B4B0F4C9B4ECFE974B94F9F64DDE570939A957B7D8938EB/InstallerSha256: ${MSI_HASH}/" {} \;

          git add "$TARGET_DIR"
          git -c user.name="github-actions" -c user.email="github-actions@github.com" commit -m "Add Shard Launcher ${VERSION}"
          git push -u origin "$BRANCH" --force

          # Check if PR already exists
          EXISTING_PR=$(gh pr list --repo "$WINGET_BASE" --head "${WINGET_FORK#*/}:$BRANCH" --json number --jq '.[0].number' 2>/dev/null || true)
          if [ -n "$EXISTING_PR" ]; then
            echo "PR #$EXISTING_PR already exists for this version"
            exit 0
          fi

          gh pr create \
            --repo "$WINGET_BASE" \
            --head "${WINGET_FORK#*/}:$BRANCH" \
            --title "Shard Launcher ${VERSION}" \
            --body "Automated update for Shard Launcher ${VERSION}." \
            --base master
